{
  "version": 3,
  "sources": ["../src/main.ts"],
  "sourcesContent": ["import * as utils from \"@iobroker/adapter-core\";\nimport dgram from \"node:dgram\";\nimport { ParserFacade } from \"./lib/parsers/parser-facade\";\nimport type { MessageBaseData } from \"./lib/parsers/parser-base-data\";\n\nclass BatriumBms extends utils.Adapter {\n    private server: dgram.Socket;\n    private parserFacade: ParserFacade;\n\n    public constructor(options: Partial<utils.AdapterOptions> = {}) {\n        super({\n            ...options,\n            name: \"batrium-bms\",\n        });\n        this.on(\"ready\", this.onReady.bind(this));\n        this.on(\"unload\", this.onUnload.bind(this));\n\n        this.server = dgram.createSocket({ type: \"udp4\" });\n        this.parserFacade = new ParserFacade(this);\n    }\n\n    private onReady(): void {\n        void this.setState(\"info.connection\", false, true);\n\n        this.server.on(\"error\", this.onServerError.bind(this));\n        this.server.on(\"listening\", this.onServerListening.bind(this));\n        this.server.on(\"message\", this.onServerMessage.bind(this));\n        this.server.on(\"close\", this.onServerClose.bind(this));\n        this.server.bind(parseInt(this.config.bindingport), this.config.bindingaddress);\n    }\n\n    private onUnload(callback: () => void): void {\n        try {\n            this.server.close();\n            callback();\n        } catch {\n            callback();\n        }\n    }\n\n    private onServerMessage(msg: Buffer, info: dgram.RemoteInfo): void {\n        const data: MessageBaseData = this.parserFacade.getMessageBaseData(msg);\n        this.log.silly(`MSG received from ${info.address} MessageID:${data.MessageId} SystemID:${data.SystemId}`);\n        void this.parserFacade.handleMessage(data.SystemId, data.MessageId, msg);\n    }\n\n    private onServerListening(): void {\n        const address = this.server.address();\n        const port = address.port;\n        const ipaddr = address.address;\n        this.log.info(`UDP Listening started on ${ipaddr}:${port}`);\n        void this.setState(\"info.connection\", true, true);\n    }\n\n    private onServerClose(): void {\n        this.log.info(\"UDP Listener Port closed.\");\n        void this.setState(\"info.connection\", false, true);\n    }\n\n    private onServerError(error: Error): void {\n        this.log.error(`Error in listener: ${error.message}`);\n        void this.setState(\"info.connection\", false, true);\n        this.restart();\n    }\n}\n\nif (require.main !== module) {\n    // Export the constructor in compact mode\n    module.exports = (options: Partial<utils.AdapterOptions> | undefined) => new BatriumBms(options);\n} else {\n    // otherwise start the instance directly\n    (() => new BatriumBms())();\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;AAAA,YAAuB;AACvB,wBAAkB;AAClB,2BAA6B;AAG7B,MAAM,mBAAmB,MAAM,QAAQ;AAAA,EAC3B;AAAA,EACA;AAAA,EAED,YAAY,UAAyC,CAAC,GAAG;AAC5D,UAAM;AAAA,MACF,GAAG;AAAA,MACH,MAAM;AAAA,IACV,CAAC;AACD,SAAK,GAAG,SAAS,KAAK,QAAQ,KAAK,IAAI,CAAC;AACxC,SAAK,GAAG,UAAU,KAAK,SAAS,KAAK,IAAI,CAAC;AAE1C,SAAK,SAAS,kBAAAA,QAAM,aAAa,EAAE,MAAM,OAAO,CAAC;AACjD,SAAK,eAAe,IAAI,kCAAa,IAAI;AAAA,EAC7C;AAAA,EAEQ,UAAgB;AACpB,SAAK,KAAK,SAAS,mBAAmB,OAAO,IAAI;AAEjD,SAAK,OAAO,GAAG,SAAS,KAAK,cAAc,KAAK,IAAI,CAAC;AACrD,SAAK,OAAO,GAAG,aAAa,KAAK,kBAAkB,KAAK,IAAI,CAAC;AAC7D,SAAK,OAAO,GAAG,WAAW,KAAK,gBAAgB,KAAK,IAAI,CAAC;AACzD,SAAK,OAAO,GAAG,SAAS,KAAK,cAAc,KAAK,IAAI,CAAC;AACrD,SAAK,OAAO,KAAK,SAAS,KAAK,OAAO,WAAW,GAAG,KAAK,OAAO,cAAc;AAAA,EAClF;AAAA,EAEQ,SAAS,UAA4B;AACzC,QAAI;AACA,WAAK,OAAO,MAAM;AAClB,eAAS;AAAA,IACb,QAAQ;AACJ,eAAS;AAAA,IACb;AAAA,EACJ;AAAA,EAEQ,gBAAgB,KAAa,MAA8B;AAC/D,UAAM,OAAwB,KAAK,aAAa,mBAAmB,GAAG;AACtE,SAAK,IAAI,MAAM,qBAAqB,KAAK,OAAO,cAAc,KAAK,SAAS,aAAa,KAAK,QAAQ,EAAE;AACxG,SAAK,KAAK,aAAa,cAAc,KAAK,UAAU,KAAK,WAAW,GAAG;AAAA,EAC3E;AAAA,EAEQ,oBAA0B;AAC9B,UAAM,UAAU,KAAK,OAAO,QAAQ;AACpC,UAAM,OAAO,QAAQ;AACrB,UAAM,SAAS,QAAQ;AACvB,SAAK,IAAI,KAAK,4BAA4B,MAAM,IAAI,IAAI,EAAE;AAC1D,SAAK,KAAK,SAAS,mBAAmB,MAAM,IAAI;AAAA,EACpD;AAAA,EAEQ,gBAAsB;AAC1B,SAAK,IAAI,KAAK,2BAA2B;AACzC,SAAK,KAAK,SAAS,mBAAmB,OAAO,IAAI;AAAA,EACrD;AAAA,EAEQ,cAAc,OAAoB;AACtC,SAAK,IAAI,MAAM,sBAAsB,MAAM,OAAO,EAAE;AACpD,SAAK,KAAK,SAAS,mBAAmB,OAAO,IAAI;AACjD,SAAK,QAAQ;AAAA,EACjB;AACJ;AAEA,IAAI,QAAQ,SAAS,QAAQ;AAEzB,SAAO,UAAU,CAAC,YAAuD,IAAI,WAAW,OAAO;AACnG,OAAO;AAEH,GAAC,MAAM,IAAI,WAAW,GAAG;AAC7B;",
  "names": ["dgram"]
}
